<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HSL Color Match Game</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: white;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 10px;
    margin: 0;
  }

  .color-box {
    width: 260px;
    height: 260px;
    max-width: 80vw;
    max-height: 80vw;
    border-radius: 16px;
    margin: 20px;
    border: 2px solid white;
  }

  .row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-top: 10px;
    width: 100%;
  }

  h1 {
    font-size: 2rem;
    text-align: center;
  }

  h3 {
    font-size: 1.3rem;
    text-align: center;
  }

  .panel {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 400px;
    margin-top: 10px;
  }

  label {
    font-size: 1.1rem;
  }

  input[type="range"] {
    width: 100%;
  }

  button {
    padding: 12px 20px;
    background: #4e6aff;
    border: none;
    border-radius: 10px;
    color: white;
    cursor: pointer;
    margin-top: 10px;
    width: 100%;
    max-width: 300px;
    font-size: 1.1rem;
  }

  .result-box {
    margin-top: 25px;
    font-size: 1.4rem;
    text-align: center;
    max-width: 90vw;
    word-wrap: break-word;
  }

  @media (max-width: 600px) {
    .color-box {
      width: 200px;
      height: 200px;
    }
    h1 {
      font-size: 1.6rem;
    }
    h3 {
      font-size: 1.2rem;
    }
  }
</style>
</head>
<body>
<h1>HSL Colour Me Suprised</h1>

<button id="modeBtn">Switch to Two-Player Mode</button>
<p id="modeText">Mode: Single Player</p>

<div class="row">
  <div>
    <h3>Target Color</h3>
    <div id="targetColor" class="color-box"></div>
  </div>
  <div>
    <h3>Your Guess</h3>
    <div id="guessColor" class="color-box"></div>
  </div>
</div>

<div class="panel">
  <label>Hue: <span id="hVal">0</span></label>
  <div id="hGrad" class="gradient-preview"></div>
  <input type="range" id="h" min="0" max="360" />

  <label>Saturation: <span id="sVal">50</span>%</label>
  <div id="sGrad" class="gradient-preview"></div>
  <input type="range" id="s" min="0" max="100" />

  <label>Lightness: <span id="lVal">50</span>%</label>
  <div id="lGrad" class="gradient-preview"></div>
  <input type="range" id="l" min="0" max="100" />
</div>

<button id="submitBtn">Submit</button>
<button id="nextBtn">Next Color</button>

<div class="result-box" id="result"></div>

<script>
// ----- state -----
let target = { h: 0, s: 0, l: 0 };
let playerTurn = 1;
let playerScores = [null, null];
let twoPlayer = false;
let reveal = false;

// ----- util: conversions -----
// hsl -> rgb (0..255)
function hslToRgb(h, s, l){
  s /= 100; l /= 100;
  const k = n => (n + h / 30) % 12;
  const a = s * Math.min(l, 1 - l);
  const f = n => l - a * Math.max(-1, Math.min(k(n) - 3, Math.min(9 - k(n), 1)));
  return [Math.round(255 * f(0)), Math.round(255 * f(8)), Math.round(255 * f(4))];
}

// rgb 0..255 -> xyz
function rgbToXyz(r,g,b){
  r /= 255; g /= 255; b /= 255;
  r = r > 0.04045 ? Math.pow((r+0.055)/1.055,2.4) : r/12.92;
  g = g > 0.04045 ? Math.pow((g+0.055)/1.055,2.4) : g/12.92;
  b = b > 0.04045 ? Math.pow((b+0.055)/1.055,2.4) : b/12.92;
  const x = (r*0.4124 + g*0.3576 + b*0.1805) / 0.95047;
  const y = (r*0.2126 + g*0.7152 + b*0.0722) / 1.00000;
  const z = (r*0.0193 + g*0.1192 + b*0.9505) / 1.08883;
  return [x,y,z];
}

// xyz -> lab
function xyzToLab(x,y,z){
  const f = t => t > 0.008856 ? Math.pow(t,1/3) : (7.787 * t) + (16/116);
  const fx = f(x); const fy = f(y); const fz = f(z);
  const L = (116 * fy) - 16;
  const a = 500 * (fx - fy);
  const b = 200 * (fy - fz);
  return [L,a,b];
}

// full hsl -> lab
function hslToLab(h,s,l){
  const [r,g,b] = hslToRgb(h,s,l);
  const [x,y,z] = rgbToXyz(r,g,b);
  return xyzToLab(x,y,z);
}

// CIEDE2000 implementation (returns deltaE value)
// Implementation based on the standard formula
function deltaE2000(lab1, lab2){
  // unpack
  const [L1, a1, b1] = lab1; const [L2, a2, b2] = lab2;
  const avgLp = (L1 + L2) / 2.0;
  const C1 = Math.hypot(a1, b1);
  const C2 = Math.hypot(a2, b2);
  const avgC = (C1 + C2) / 2.0;
  const G = 0.5 * (1 - Math.sqrt(Math.pow(avgC,7) / (Math.pow(avgC,7) + Math.pow(25,7))));
  const a1p = (1+G)*a1;
  const a2p = (1+G)*a2;
  const C1p = Math.hypot(a1p, b1);
  const C2p = Math.hypot(a2p, b2);
  const avgCp = (C1p + C2p) / 2.0;
  const h1p = Math.atan2(b1, a1p) * 180 / Math.PI; if (h1p < 0) h1p += 360;
  const h2p = Math.atan2(b2, a2p) * 180 / Math.PI; if (h2p < 0) h2p += 360;
  let dhp = h2p - h1p;
  if (Math.abs(dhp) > 180) dhp += (dhp > 0) ? -360 : 360;
  const dLp = L2 - L1;
  const dCp = C2p - C1p;
  const dHp = 2 * Math.sqrt(C1p*C2p) * Math.sin((Math.PI/180) * (dhp/2));
  const avgHp = Math.abs(h1p - h2p) > 180 ? (h1p + h2p + 360)/2 : (h1p + h2p)/2;
  const T = 1 - 0.17*Math.cos((Math.PI/180)*(avgHp - 30)) + 0.24*Math.cos((Math.PI/180)*(2*avgHp)) + 0.32*Math.cos((Math.PI/180)*(3*avgHp + 6)) - 0.20*Math.cos((Math.PI/180)*(4*avgHp - 63));
  const SL = 1 + ((0.015 * Math.pow(avgLp - 50,2)) / Math.sqrt(20 + Math.pow(avgLp - 50,2)));
  const SC = 1 + 0.045 * avgCp;
  const SH = 1 + 0.015 * avgCp * T;
  const deltaRo = 30 * Math.exp(-Math.pow((avgHp - 275)/25,2));
  const RC = 2 * Math.sqrt(Math.pow(avgCp,7) / (Math.pow(avgCp,7) + Math.pow(25,7)));
  const RT = -Math.sin((Math.PI/180)*(2*deltaRo)) * RC;
  const kL = 1, kC = 1, kH = 1;
  const dE = Math.sqrt(
    Math.pow(dLp / (kL * SL),2) +
    Math.pow(dCp / (kC * SC),2) +
    Math.pow(dHp / (kH * SH),2) +
    RT * (dCp / (kC * SC)) * (dHp / (kH * SH))
  );
  return dE;
}

// ----- helpers -----
function randomColor(){
  return { h: Math.floor(Math.random()*360), s: Math.floor(Math.random()*100), l: Math.floor(Math.random()*100) };
}

function hslToHex(h, s, l) {
  const [r,g,b] = hslToRgb(h,s,l);
  const toHex = v => v.toString(16).padStart(2,'0');
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

// ----- UI references -----
const hSlider = document.getElementById("h");
const sSlider = document.getElementById("s");
const lSlider = document.getElementById("l");
const hVal = document.getElementById("hVal");
const sVal = document.getElementById("sVal");
const lVal = document.getElementById("lVal");
const hGrad = document.getElementById("hGrad");
const sGrad = document.getElementById("sGrad");
const lGrad = document.getElementById("lGrad");
const guessColor = document.getElementById("guessColor");
const resultBox = document.getElementById("result");

function updateGradients(){
  const h = Number(hSlider.value);
  hGrad.style.background = `linear-gradient(to right, hsl(0,100%,50%), hsl(60,100%,50%), hsl(120,100%,50%), hsl(180,100%,50%), hsl(240,100%,50%), hsl(300,100%,50%), hsl(360,100%,50%))`;
  sGrad.style.background = `linear-gradient(to right, hsl(${h},0%,50%), hsl(${h},100%,50%))`;
  lGrad.style.background = `linear-gradient(to right, hsl(${h},100%,0%), hsl(${h},100%,50%), hsl(${h},100%,100%))`;
}

function updateGuessColor(){
  const h = Number(hSlider.value);
  const s = Number(sSlider.value);
  const l = Number(lSlider.value);
  hVal.innerText = h;
  sVal.innerText = s;
  lVal.innerText = l;
  guessColor.style.background = `hsl(${h}, ${s}%, ${l}%)`;
  updateGradients();
}

[hSlider, sSlider, lSlider].forEach(el => el.addEventListener("input", updateGuessColor));

// reset sliders and UI selection
function resetSliders(){
  hSlider.value = 0; sSlider.value = 50; lSlider.value = 50; updateGuessColor();
}

// ----- mode button -----
document.getElementById("modeBtn").onclick = () => {
  twoPlayer = !twoPlayer;
  playerTurn = 1;
  playerScores = [null, null];
  reveal = false;
  resultBox.innerHTML = "";
  document.getElementById("modeText").innerText = twoPlayer ? "Mode: Two Player" : "Mode: Single Player";
  resetSliders();
};

// ----- scoring -----
function calculateScore(targetHSL, guessHSL){
  // convert to Lab and compute deltaE
  const labTarget = hslToLab(targetHSL.h, targetHSL.s, targetHSL.l);
  const labGuess = hslToLab(guessHSL.h, guessHSL.s, guessHSL.l);
  const dE = deltaE2000(labTarget, labGuess);
  // map deltaE to percentage similarity: smaller dE -> closer to 100%
  // Typical perceptual range: 0..100+ but most differences <100. We'll clamp and normalize by 100.
  const similarity = Math.max(0, 100 - (dE)); // rough mapping: dE=0 ->100%, dE=100 ->0%
  return { dE: dE, similarity: Math.max(0, Math.min(100, similarity)) };
}

// submit handler
document.getElementById("submitBtn").onclick = () => {
  const guess = { h: Number(hSlider.value), s: Number(sSlider.value), l: Number(lSlider.value) };
  const { dE, similarity } = calculateScore(target, guess);
  // numeric precision: show many decimals if desired
  const simStr = similarity.toFixed(6) + "%"; // six decimal places

  if (!twoPlayer) {
    reveal = true;
    resultBox.innerHTML = `<div style="font-size:1.6rem; font-weight:600;">Score: ${simStr}</div>
` +
      `<div class="code">Î”E: ${dE.toFixed(6)}</div>
` +
      `<div>HSL: <span class="code">hsl(${target.h}, ${target.s}%, ${target.l}%)</span></div>
` +
      `<div>HEX: <span class="code">${hslToHex(target.h, target.s, target.l)}</span></div>`;
    resetSliders();
    return;
  }

  // two player mode
  playerScores[playerTurn-1] = similarity; // store raw percentage
  resetSliders();
  if (playerTurn === 1) {
    playerTurn = 2;
    alert('Player 2: your turn');
    return;
  }

  // both players have played
  reveal = true;
  const p1 = playerScores[0];
  const p2 = playerScores[1];
  let winner = 'Tie!';
  if (p1 > p2) winner = 'Player 1 wins!';
  if (p2 > p1) winner = 'Player 2 wins!';

  resultBox.innerHTML = `<div style="font-size:1.4rem; font-weight:600;">P1: ${p1.toFixed(6)}% | P2: ${p2.toFixed(6)}%</div>
` +
    `<div style="margin-top:8px; font-weight:700;">${winner}</div>
` +
    `<div style="margin-top:12px">HSL: <span class="code">hsl(${target.h}, ${target.s}%, ${target.l}%)</span></div>
` +
    `<div>HEX: <span class="code">${hslToHex(target.h, target.s, target.l)}</span></div>`;
};

// next color
document.getElementById("nextBtn").onclick = () => {
  reveal = false;
  target = randomColor();
  resultBox.innerHTML = "";
  playerTurn = 1;
  playerScores = [null, null];
  document.getElementById("targetColor").style.background = `hsl(${target.h}, ${target.s}%, ${target.l}%)`;
  resetSliders();
};

// init
(function init(){
  target = randomColor();
  document.getElementById("targetColor").style.background = `hsl(${target.h}, ${target.s}%, ${target.l}%)`;
  resetSliders();
})();
</script>
</body>
</html>
